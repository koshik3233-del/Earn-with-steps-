<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitChain - Auto Step Tracking & Rewards</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #00c853;
            --primary-dark: #00b248;
            --secondary: #2962ff;
            --dark: #1a1a2e;
            --light: #ffffff;
            --gray: #6c757d;
            --card-bg: rgba(255, 255, 255, 0.05);
            --warning: #ff9800;
            --error: #f44336;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: var(--light);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Login/Signup Page */
        .auth-page {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(rgba(26, 26, 46, 0.9), rgba(26, 26, 46, 0.9));
        }

        .auth-box {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 50px;
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 30px;
        }

        .auth-box h2 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .auth-box p {
            color: #ccc;
            margin-bottom: 30px;
            font-size: 1rem;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .auth-tab {
            flex: 1;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            color: white;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .auth-tab.active {
            background: var(--primary);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #ccc;
            font-size: 0.9rem;
        }

        .input-group input {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 14px 30px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            transition: background 0.3s;
        }

        .btn:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--secondary);
        }

        .btn-secondary:hover {
            background: #2048d6;
        }

        .btn-warning {
            background: var(--warning);
        }

        .btn-warning:hover {
            background: #e68900;
        }

        .google-btn {
            background: white;
            color: #333;
            margin: 20px 0;
        }

        .google-btn:hover {
            background: #f0f0f0;
        }

        /* Dashboard */
        .dashboard {
            display: none;
            padding-top: 80px;
        }

        /* Header */
        header {
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(10px);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--primary);
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
        }

        .user-tokens {
            color: var(--primary);
            font-size: 0.9rem;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
        }

        /* Permission Banner */
        .permission-banner {
            background: linear-gradient(45deg, var(--warning), #ff6b35);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.9; }
            50% { opacity: 1; }
            100% { opacity: 0.9; }
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .stat-label {
            color: #ccc;
            font-size: 1rem;
        }

        .stat-subtext {
            color: var(--primary);
            font-size: 0.9rem;
            margin-top: 5px;
        }

        /* Auto Tracking Section */
        .auto-tracking {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }

        .auto-tracking h3 {
            margin-bottom: 20px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tracking-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--error);
        }

        .status-dot.active {
            background: var(--primary);
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .permission-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .permission-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .permission-card.granted {
            border: 2px solid var(--primary);
            background: rgba(0, 200, 83, 0.1);
        }

        .permission-card i {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--primary);
        }

        /* Steps Counter */
        .steps-counter {
            text-align: center;
            padding: 30px;
            background: rgba(0, 200, 83, 0.1);
            border-radius: 15px;
            border: 2px solid var(--primary);
            margin-bottom: 30px;
        }

        .steps-value {
            font-size: 4rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .steps-label {
            font-size: 1.2rem;
            color: #ccc;
            margin-bottom: 20px;
        }

        .earnings-info {
            font-size: 1.1rem;
            color: var(--primary);
        }

        /* Withdrawal Section */
        .withdrawal-section {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 40px;
        }

        .withdrawal-section h3 {
            margin-bottom: 20px;
            color: var(--primary);
        }

        .conversion-rate {
            background: rgba(41, 98, 255, 0.1);
            border: 1px solid #2962ff;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .conversion-rate h4 {
            color: #2962ff;
            margin-bottom: 10px;
        }

        .withdrawal-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .withdrawal-form input {
            flex: 1;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
        }

        .withdrawal-form .btn {
            width: auto;
        }

        /* Activity History */
        .activity-history {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .activity-history h3 {
            margin-bottom: 20px;
            color: var(--primary);
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            background: rgba(0, 200, 83, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
        }

        .activity-details {
            flex: 1;
        }

        .activity-details div:first-child {
            font-weight: 500;
        }

        .activity-details div:last-child {
            font-size: 0.9rem;
            color: #ccc;
        }

        .activity-tokens {
            color: var(--primary);
            font-weight: 600;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--dark);
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            border: 2px solid var(--primary);
        }

        .modal-content h3 {
            color: var(--primary);
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons button {
            flex: 1;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .auth-box {
                padding: 30px 20px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .permission-grid {
                grid-template-columns: 1fr;
            }

            .withdrawal-form {
                flex-direction: column;
            }

            .withdrawal-form .btn {
                width: 100%;
            }

            .modal-buttons {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .nav-container {
                flex-direction: column;
                gap: 15px;
            }

            .steps-value {
                font-size: 3rem;
            }
        }
    </style>
</head>
<body>
    <!-- Login/Signup Page -->
    <div class="auth-page" id="authPage">
        <div class="container">
            <div class="auth-box">
                <div class="logo">
                    <i class="fas fa-dumbbell"></i>
                    <span>FitChain</span>
                </div>
                
                <h2>Auto Step Tracking & Rewards</h2>
                <p>Automatically track your steps using device sensors. Earn â‚¹0.5 for every 1000 steps!</p>
                
                <div class="auth-tabs">
                    <button class="auth-tab active" onclick="showTab('login')">Login</button>
                    <button class="auth-tab" onclick="showTab('signup')">Sign Up</button>
                </div>
                
                <!-- Login Form -->
                <form id="loginForm" class="auth-form active" onsubmit="handleLogin(event)">
                    <div class="input-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" placeholder="Enter your email" required>
                    </div>
                    
                    <div class="input-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password" required>
                    </div>
                    
                    <button type="submit" class="btn">Login</button>
                    
                    <!-- Google Sign-in -->
                    <div id="g_id_onload"
                         data-client_id="875424435154-951lkei3ab7l43ipml4upvqtvjl2is64.apps.googleusercontent.com"
                         data-context="signin"
                         data-ux_mode="popup"
                         data-callback="handleGoogleLogin"
                         data-auto_prompt="false">
                    </div>

                    <button type="button" class="btn google-btn" onclick="googleSignIn()">
                        <i class="fab fa-google"></i> Continue with Google
                    </button>
                </form>
                
                <!-- Signup Form -->
                <form id="signupForm" class="auth-form" onsubmit="handleSignup(event)">
                    <div class="input-group">
                        <label for="signupName">Full Name</label>
                        <input type="text" id="signupName" placeholder="Enter your full name" required>
                    </div>
                    
                    <div class="input-group">
                        <label for="signupEmail">Email</label>
                        <input type="email" id="signupEmail" placeholder="Enter your email" required>
                    </div>
                    
                    <div class="input-group">
                        <label for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" placeholder="Create a password" required>
                    </div>
                    
                    <div class="input-group">
                        <label for="signupConfirmPassword">Confirm Password</label>
                        <input type="password" id="signupConfirmPassword" placeholder="Confirm your password" required>
                    </div>
                    
                    <button type="submit" class="btn">Create Account</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <header>
            <div class="container nav-container">
                <div class="logo">
                    <i class="fas fa-dumbbell"></i>
                    <span>FitChain</span>
                </div>
                
                <div class="user-info">
                    <img id="userAvatar" class="user-avatar" src="https://ui-avatars.com/api/?name=User&background=00c853&color=fff" alt="User Avatar">
                    <div class="user-details">
                        <span id="userName" class="user-name">User</span>
                        <span id="userTokens" class="user-tokens">100 FCH (â‚¹50)</span>
                    </div>
                    <button onclick="logout()" class="logout-btn">Logout</button>
                </div>
            </div>
        </header>
        
        <main class="container">
            <!-- Permission Banner -->
            <div class="permission-banner" id="permissionBanner">
                <div>
                    <h4><i class="fas fa-exclamation-triangle"></i> Permissions Required</h4>
                    <p>Enable step tracking and location access to start earning automatically</p>
                </div>
                <button onclick="requestAllPermissions()" class="btn btn-warning">Enable Now</button>
            </div>
            
            <!-- Stats Overview -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalTokens">100</div>
                    <div class="stat-label">Total Tokens</div>
                    <div class="stat-subtext" id="tokenValue">â‚¹50.00</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="todaySteps">0</div>
                    <div class="stat-label">Today's Steps</div>
                    <div class="stat-subtext" id="todayEarnings">â‚¹0.00 earned</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="totalSteps">0</div>
                    <div class="stat-label">Total Steps</div>
                    <div class="stat-subtext" id="totalEarnings">â‚¹0.00 earned</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="withdrawBalance">â‚¹50</div>
                    <div class="stat-label">Available to Withdraw</div>
                </div>
            </div>
            
            <!-- Auto Tracking Section -->
            <div class="auto-tracking">
                <h3><i class="fas fa-sync-alt"></i> Auto Step Tracking</h3>
                
                <div class="tracking-status">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Step tracking is paused</span>
                </div>
                
                <div class="permission-grid">
                    <div class="permission-card" id="locationPermission">
                        <i class="fas fa-map-marker-alt"></i>
                        <h4>Location Access</h4>
                        <p id="locationStatus">Not Granted</p>
                    </div>
                    
                    <div class="permission-card" id="sensorPermission">
                        <i class="fas fa-mobile-alt"></i>
                        <h4>Device Sensors</h4>
                        <p id="sensorStatus">Not Granted</p>
                    </div>
                    
                    <div class="permission-card" id="activityPermission">
                        <i class="fas fa-running"></i>
                        <h4>Activity Recognition</h4>
                        <p id="activityStatus">Not Granted</p>
                    </div>
                </div>
                
                <div class="steps-counter">
                    <div class="steps-value" id="liveSteps">0</div>
                    <div class="steps-label">STEPS COUNTED</div>
                    <div class="earnings-info" id="liveEarnings">Earnings: â‚¹0.00 (0 tokens)</div>
                </div>
                
                <button onclick="startStepTracking()" class="btn btn-secondary" id="trackingButton">
                    <i class="fas fa-play"></i> Start Tracking
                </button>
                <button onclick="pauseStepTracking()" class="btn" style="margin-top: 10px;">
                    <i class="fas fa-pause"></i> Pause Tracking
                </button>
            </div>
            
            <!-- Withdrawal Section -->
            <div class="withdrawal-section">
                <h3><i class="fas fa-wallet"></i> Withdraw Earnings</h3>
                
                <div class="conversion-rate">
                    <h4>Real-time Conversion</h4>
                    <p>1000 steps = 1 FCH Token = â‚¹0.5</p>
                    <p><strong>Current Balance:</strong> <span id="withdrawTokens">100</span> FCH = â‚¹<span id="withdrawRupees">50.00</span></p>
                </div>
                
                <div class="withdrawal-form">
                    <input type="number" id="withdrawAmount" placeholder="Enter tokens to withdraw" min="20" max="1000">
                    <button onclick="withdrawTokens()" class="btn">Withdraw Now</button>
                </div>
                
                <p style="color: #ccc; font-size: 0.9rem;">
                    <i class="fas fa-info-circle"></i> Minimum withdrawal: 20 FCH (â‚¹10). 
                    Withdrawals processed within 24 hours.
                </p>
            </div>
            
            <!-- Activity History -->
            <div class="activity-history">
                <h3><i class="fas fa-history"></i> Step Tracking History</h3>
                <div id="activityHistory">
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="activity-details">
                            <div>Account Created</div>
                            <div>Just now</div>
                        </div>
                        <div class="activity-tokens">+100 FCH</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Permission Modal -->
    <div class="modal" id="permissionModal">
        <div class="modal-content">
            <h3><i class="fas fa-shield-alt"></i> Permissions Required</h3>
            <p>To track your steps automatically, FitChain needs the following permissions:</p>
            
            <ul style="margin: 20px 0; padding-left: 20px;">
                <li style="margin-bottom: 10px;">
                    <strong>Location Access:</strong> To track walking/running routes
                </li>
                <li style="margin-bottom: 10px;">
                    <strong>Device Sensors:</strong> To detect steps using accelerometer
                </li>
                <li>
                    <strong>Activity Recognition:</strong> To identify walking/running activity
                </li>
            </ul>
            
            <p style="color: #ccc; font-size: 0.9rem;">
                <i class="fas fa-lock"></i> Your data is secure and only used for step counting.
            </p>
            
            <div class="modal-buttons">
                <button onclick="grantAllPermissions()" class="btn">
                    <i class="fas fa-check"></i> Allow All Permissions
                </button>
                <button onclick="closeModal()" class="btn" style="background: var(--gray);">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal" id="successModal">
        <div class="modal-content">
            <h3 style="color: var(--primary);"><i class="fas fa-trophy"></i> Step Tracking Active!</h3>
            <p>Your steps are now being tracked automatically. Start walking to earn tokens!</p>
            <p style="margin: 15px 0; font-size: 1.2rem; color: var(--primary);">
                <strong>Earning Rate:</strong> 1000 steps = 1 FCH Token = â‚¹0.5
            </p>
            <button onclick="closeSuccessModal()" class="btn">Start Earning!</button>
        </div>
    </div>

    <script>
        // User Data
        let userData = {
            isLoggedIn: false,
            name: 'User',
            email: '',
            tokens: 100,
            dailySteps: 0,
            totalSteps: 0,
            stepHistory: [],
            activities: [
                { type: 'signup', message: 'Account Created', time: 'Just now', tokens: 100 }
            ],
            permissions: {
                location: false,
                sensors: false,
                activity: false
            },
            isTracking: false
        };

        // Step Tracking Variables
        const TOKEN_VALUE = 0.5; // â‚¹0.5 per token
        const STEPS_PER_TOKEN = 100; // 100 steps = 1 token
        const MIN_WITHDRAWAL = 20; // Minimum 20 tokens to withdraw
        let stepCount = 0;
        let lastStepTime = Date.now();
        let stepInterval;
        let simulatedStepCount = 0;
        let lastSavedSteps = 0;

        // DOM Elements
        const authPage = document.getElementById('authPage');
        const dashboard = document.getElementById('dashboard');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const permissionModal = document.getElementById('permissionModal');
        const successModal = document.getElementById('successModal');
        const permissionBanner = document.getElementById('permissionBanner');

        // Tab Switching
        function showTab(tabName) {
            // Update active tab
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.textContent.toLowerCase().includes(tabName)) {
                    tab.classList.add('active');
                }
            });
            
            // Show active form
            loginForm.classList.remove('active');
            signupForm.classList.remove('active');
            
            if (tabName === 'login') {
                loginForm.classList.add('active');
            } else {
                signupForm.classList.add('active');
            }
        }

        // Handle Login
        function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                alert('Please enter both email and password');
                return;
            }
            
            userData.email = email;
            userData.name = email.split('@')[0];
            userData.isLoggedIn = true;
            
            localStorage.setItem('fitChainUser', JSON.stringify(userData));
            showDashboard();
        }

        // Handle Signup
        function handleSignup(event) {
            event.preventDefault();
            
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            
            if (!name || !email || !password || !confirmPassword) {
                alert('Please fill all fields');
                return;
            }
            
            if (password !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }
            
            userData.name = name;
            userData.email = email;
            userData.isLoggedIn = true;
            
            localStorage.setItem('fitChainUser', JSON.stringify(userData));
            
            showDashboard();
        }

        // Google Sign-in
        function googleSignIn() {
            google.accounts.id.prompt();
        }

        // Handle Google Login
        function handleGoogleLogin(response) {
            const user = response.credential ? parseJwt(response.credential) : response;
            
            userData = {
                isLoggedIn: true,
                name: user.name || user.given_name + ' ' + user.family_name,
                email: user.email,
                tokens: 100,
                dailySteps: 0,
                totalSteps: 0,
                stepHistory: [],
                activities: [
                    { type: 'signup', message: 'Account Created via Google', time: getCurrentTime(), tokens: 100 }
                ],
                permissions: {
                    location: false,
                    sensors: false,
                    activity: false
                },
                isTracking: false
            };
            
            localStorage.setItem('fitChainUser', JSON.stringify(userData));
            showDashboard();
        }

        // Show Dashboard
        function showDashboard() {
            authPage.style.display = 'none';
            dashboard.style.display = 'block';
            
            const savedUser = localStorage.getItem('fitChainUser');
            if (savedUser) {
                userData = JSON.parse(savedUser);
            }
            
            updateDashboard();
            
            // Show permission modal if permissions not granted
            if (!userData.permissions.location || !userData.permissions.sensors) {
                setTimeout(() => {
                    permissionModal.style.display = 'flex';
                }, 1000);
            }
        }

        // Update Dashboard
        function updateDashboard() {
            // Update user info
            document.getElementById('userName').textContent = userData.name;
            document.getElementById('userAvatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(userData.name)}&background=00c853&color=fff`;
            
            // Update stats
            const totalRupees = (userData.tokens * TOKEN_VALUE).toFixed(2);
            const todayRupees = (Math.floor(userData.dailySteps / STEPS_PER_TOKEN) * TOKEN_VALUE).toFixed(2);
            const totalEarned = (Math.floor(userData.totalSteps / STEPS_PER_TOKEN) * TOKEN_VALUE).toFixed(2);
            
            document.getElementById('totalTokens').textContent = userData.tokens;
            document.getElementById('userTokens').textContent = `${userData.tokens} FCH (â‚¹${totalRupees})`;
            document.getElementById('tokenValue').textContent = `â‚¹${totalRupees}`;
            document.getElementById('todaySteps').textContent = userData.dailySteps.toLocaleString();
            document.getElementById('todayEarnings').textContent = `â‚¹${todayRupees} earned`;
            document.getElementById('totalSteps').textContent = userData.totalSteps.toLocaleString();
            document.getElementById('totalEarnings').textContent = `â‚¹${totalEarned} earned`;
            document.getElementById('withdrawBalance').textContent = `â‚¹${totalRupees}`;
            document.getElementById('withdrawTokens').textContent = userData.tokens;
            document.getElementById('withdrawRupees').textContent = totalRupees;
            
            // Update permission status
            updatePermissionStatus();
            
            // Update tracking status
            updateTrackingStatus();
            
            // Update activity history
            updateActivityHistory();
        }

        // Update Permission Status
        function updatePermissionStatus() {
            const locationCard = document.getElementById('locationPermission');
            const sensorCard = document.getElementById('sensorPermission');
            const activityCard = document.getElementById('activityPermission');
            
            if (userData.permissions.location) {
                locationCard.classList.add('granted');
                document.getElementById('locationStatus').textContent = 'Granted';
                document.getElementById('locationStatus').style.color = '#00c853';
            }
            
            if (userData.permissions.sensors) {
                sensorCard.classList.add('granted');
                document.getElementById('sensorStatus').textContent = 'Granted';
                document.getElementById('sensorStatus').style.color = '#00c853';
            }
            
            if (userData.permissions.activity) {
                activityCard.classList.add('granted');
                document.getElementById('activityStatus').textContent = 'Granted';
                document.getElementById('activityStatus').style.color = '#00c853';
            }
            
            // Hide permission banner if all permissions granted
            if (userData.permissions.location && userData.permissions.sensors) {
                permissionBanner.style.display = 'none';
            }
        }

        // Request All Permissions
        function requestAllPermissions() {
            permissionModal.style.display = 'flex';
        }

        // Grant All Permissions
        function grantAllPermissions() {
            // Request Geolocation Permission
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    () => {
                        userData.permissions.location = true;
                        updatePermissionStatus();
                        saveUserData();
                    },
                    () => {
                        alert('Location permission is required for accurate step tracking.');
                    }
                );
            }
            
            // Simulate sensor permission (in real app, this would use DeviceMotion API)
            userData.permissions.sensors = true;
            
            // Simulate activity recognition permission
            userData.permissions.activity = true;
            
            // Update UI
            updatePermissionStatus();
            
            // Save permissions
            saveUserData();
            
            // Close modal and show success
            closeModal();
            
            // Auto-start tracking if all permissions granted
            if (userData.permissions.location && userData.permissions.sensors) {
                setTimeout(() => {
                    successModal.style.display = 'flex';
                    startStepTracking();
                }, 500);
            }
        }

        // Start Step Tracking
        function startStepTracking() {
            if (!userData.permissions.sensors) {
                alert('Please enable device sensor permissions first');
                requestAllPermissions();
                return;
            }
            
            userData.isTracking = true;
            updateTrackingStatus();
            
            // Start simulated step counting (in real app, this would use DeviceMotion API)
            clearInterval(stepInterval);
            stepInterval = setInterval(() => {
                // Simulate step detection - in real app, this would come from accelerometer
                const now = Date.now();
                if (now - lastStepTime > 500) { // Simulate 2 steps per second max
                    stepCount++;
                    simulatedStepCount++;
                    lastStepTime = now;
                    
                    // Update live display every 10 steps
                    if (stepCount % 10 === 0) {
                        updateLiveSteps();
                        
                        // Save steps every 100 steps
                        if (stepCount - lastSavedSteps >= 100) {
                            saveStepsToUserData();
                        }
                    }
                }
            }, 100);
            
            // Add activity
            userData.activities.unshift({
                type: 'tracking',
                message: 'Started auto step tracking',
                time: getCurrentTime(),
                tokens: 0
            });
            
            updateActivityHistory();
            saveUserData();
        }

        // Pause Step Tracking
        function pauseStepTracking() {
            userData.isTracking = false;
            clearInterval(stepInterval);
            
            // Save any remaining steps
            if (stepCount > 0) {
                saveStepsToUserData();
            }
            
            updateTrackingStatus();
            
            // Add activity
            userData.activities.unshift({
                type: 'tracking',
                message: 'Paused step tracking',
                time: getCurrentTime(),
                tokens: 0
            });
            
            updateActivityHistory();
            saveUserData();
        }

        // Update Live Steps Display
        function updateLiveSteps() {
            const totalSteps = userData.dailySteps + stepCount;
            const tokensEarned = Math.floor(totalSteps / STEPS_PER_TOKEN);
            const rupeesEarned = (tokensEarned * TOKEN_VALUE).toFixed(2);
            
            document.getElementById('liveSteps').textContent = totalSteps.toLocaleString();
            document.getElementById('liveEarnings').textContent = 
                `Earnings: â‚¹${rupeesEarned} (${tokensEarned} tokens)`;
        }

        // Save Steps to User Data
        function saveStepsToUserData() {
            if (stepCount > 0) {
                userData.dailySteps += stepCount;
                userData.totalSteps += stepCount;
                
                // Calculate tokens earned from new steps
                const newTokens = Math.floor(stepCount / STEPS_PER_TOKEN);
                if (newTokens > 0) {
                    userData.tokens += newTokens;
                    
                    // Add activity for step earnings
                    userData.activities.unshift({
                        type: 'steps',
                        message: `Walked ${stepCount.toLocaleString()} steps`,
                        time: getCurrentTime(),
                        tokens: newTokens
                    });
                    
                    // Show notification for earnings
                    if (newTokens >= 1) {
                        showEarningNotification(newTokens);
                    }
                }
                
                // Reset step count
                lastSavedSteps = stepCount;
                stepCount = 0;
                
                // Update dashboard
                updateDashboard();
                saveUserData();
            }
        }

        // Show Earning Notification
        function showEarningNotification(tokens) {
            const rupees = (tokens * TOKEN_VALUE).toFixed(2);
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: linear-gradient(45deg, #00c853, #00b248);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                z-index: 3000;
                box-shadow: 0 5px 15px rgba(0, 200, 83, 0.3);
                animation: slideIn 0.5s ease-out;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-coins" style="font-size: 1.5rem;"></i>
                    <div>
                        <div style="font-weight: 600;">ðŸŽ‰ Tokens Earned!</div>
                        <div>+${tokens} FCH = â‚¹${rupees}</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.5s ease-out';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
            
            // Add CSS for animations
            if (!document.getElementById('notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // Update Tracking Status
        function updateTrackingStatus() {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const trackingButton = document.getElementById('trackingButton');
            
            if (userData.isTracking) {
                statusDot.classList.add('active');
                statusText.textContent = 'Step tracking is active';
                statusText.style.color = '#00c853';
                trackingButton.innerHTML = '<i class="fas fa-sync fa-spin"></i> Tracking Active';
                trackingButton.disabled = true;
            } else {
                statusDot.classList.remove('active');
                statusText.textContent = 'Step tracking is paused';
                statusText.style.color = '#ccc';
                trackingButton.innerHTML = '<i class="fas fa-play"></i> Start Tracking';
                trackingButton.disabled = false;
            }
        }

        // Withdraw Tokens
        function withdrawTokens() {
            const withdrawInput = document.getElementById('withdrawAmount');
            const tokens = parseInt(withdrawInput.value);
            
            if (!tokens || tokens < MIN_WITHDRAWAL) {
                alert(`Minimum withdrawal is ${MIN_WITHDRAWAL} FCH (â‚¹${MIN_WITHDRAWAL * TOKEN_VALUE})`);
                return;
            }
            
            if (tokens > userData.tokens) {
                alert(`You only have ${userData.tokens} FCH available`);
                return;
            }
            
            const rupees = (tokens * TOKEN_VALUE).toFixed(2);
            if (confirm(`Withdraw ${tokens} FCH tokens (â‚¹${rupees})?\n\nAmount will be sent to your registered payment method within 24 hours.`)) {
                userData.tokens -= tokens;
                
                userData.activities.unshift({
                    type: 'withdrawal',
                    message: `Withdrawn ${tokens} FCH (â‚¹${rupees})`,
                    time: getCurrentTime(),
                    tokens: -tokens
                });
                
                updateDashboard();
                saveUserData();
                
                alert(`âœ… Withdrawal request submitted!\n\n${tokens} FCH (â‚¹${rupees}) will be processed within 24 hours.`);
                
                withdrawInput.value = '';
            }
        }

        // Update Activity History
        function updateActivityHistory() {
            const container = document.getElementById('activityHistory');
            container.innerHTML = '';
            
            const activitiesToShow = userData.activities.slice(0, 10);
            
            activitiesToShow.forEach(activity => {
                const item = document.createElement('div');
                item.className = 'activity-item';
                
                let icon = 'fas fa-user-plus';
                if (activity.type === 'steps') icon = 'fas fa-walking';
                if (activity.type === 'tracking') icon = 'fas fa-sync-alt';
                if (activity.type === 'withdrawal') icon = 'fas fa-wallet';
                
                let tokenDisplay = '';
                if (activity.tokens > 0) {
                    tokenDisplay = `+${activity.tokens} FCH`;
                } else if (activity.tokens < 0) {
                    tokenDisplay = `${activity.tokens} FCH`;
                } else {
                    tokenDisplay = '';
                }
                
                item.innerHTML = `
                    <div class="activity-icon">
                        <i class="${icon}"></i>
                    </div>
                    <div class="activity-details">
                        <div>${activity.message}</div>
                        <div>${activity.time}</div>
                    </div>
                    <div class="activity-tokens" style="${activity.tokens < 0 ? 'color: #ff6b6b;' : ''}">
                        ${tokenDisplay}
                    </div>
                `;
                
                container.appendChild(item);
            });
        }

        // Get Current Time
        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Parse JWT Token
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                return JSON.parse(atob(base64));
            } catch (e) {
                return {};
            }
        }

        // Save User Data
        function saveUserData() {
            localStorage.setItem('fitChainUser', JSON.stringify(userData));
        }

        // Close Modal
        function closeModal() {
            permissionModal.style.display = 'none';
        }

        // Close Success Modal
        function closeSuccessModal() {
            successModal.style.display = 'none';
        }

        // Logout
        function logout() {
            // Stop tracking
            pauseStepTracking();
            
            userData.isLoggedIn = false;
            localStorage.removeItem('fitChainUser');
            
            authPage.style.display = 'flex';
            dashboard.style.display = 'none';
            
            // Reset forms
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('signupName').value = '';
            document.getElementById('signupEmail').value = '';
            document.getElementById('signupPassword').value = '';
            document.getElementById('signupConfirmPassword').value = '';
            
            showTab('login');
        }

        // Initialize
        function init() {
            const savedUser = localStorage.getItem('fitChainUser');
            if (savedUser) {
                userData = JSON.parse(savedUser);
                if (userData.isLoggedIn) {
                    showDashboard();
                }
            }
            
            // Initialize Google Sign-in
            google.accounts.id.initialize({
                client_id: '875424435154-951lkei3ab7l43ipml4upvqtvjl2is64.apps.googleusercontent.com',
                callback: handleGoogleLogin
            });
            
            // Check for DeviceMotion API support (for real step tracking)
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                // iOS 13+ devices
                document.getElementById('sensorStatus').textContent = 'Tap to enable';
            } else if ('DeviceMotionEvent' in window) {
                // Android and older iOS
                document.getElementById('sensorStatus').textContent = 'Available';
            }
        }

        // Run initialization when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>